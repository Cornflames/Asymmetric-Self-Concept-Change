---
title: "Appendix B"
format:
  html:
    toc: true
  pdf:
    documentclass: scrartcl
    toc: false
    number-sections: false
    colorlinks: true
    include-in-header: 
      text: '\pagenumbering{gobble}'
editor: visual
---

In dieser Datei wird eine vollständige Re-Implementation-Reproduction von Studie 4 aus Brotzeller und Gollwitzer (2025) nach den Schritten durchgeführt, die das *Conceptual-Framework-for-Computational-Reproductions* (Kohrt et al., 2024) vorgibt. Eine besser lesbare HTML-Version dieser Datei befindet sich in den [Zusatzmaterialien](https://github.com/Cornflames/Asymmetric-Self-Concept-Change.git) der vorliegenden Bachelorarbeit.

## (a) Defining the Scope

-   **Works**: Studie 4 aus Brotzeller und Gollwitzer (2025)
-   **Claims**:
    -   H1 bestätigt: Größere Diskrepanzen zwischen Feedback und Selbstwahrnehmung ziehen größere Selbstkonzeptänderungen nach sich (S. 1739)
    -   H2 widerlegt: Die wahrgenommenen Verbesserungsmöglichkeiten ziehen keine Asymmetrien in den Selbstkonzeptänderungen nach sich (S. 1739)
-   **Results**: Tabelle 2 auf S. 1739. Diese Tabelle bildet alle Koeffizienten des Regressionsmodells mit den Prädiktoren `size of discrepancy (SoD)`, `direction of discrepancy (DoD)` und `opportunity for improvement (OFI)` sowie all ihren Interaktionen ab. Das Modell sagt die *absoluten* Selbstkonzeptänderungen vorher.
-   **Obtained data**: Anonymisierte Primärdaten, die [hier](https://osf.io/yadqw) aus dem OSF abrufbar sind.
    -   Die Primärdaten wurden schon insofern vorverarbeitet, als die Prädiktorvariablen des Regressionmodells bereits aus den Primärdaten im Datensatz errechnet wurden. Dieser Verarbeitungsschritt wird wiederholt.
    -   Der Datensatz enthält noch alle Versuchspersonen, die Brotzeller & Gollwitzer (2025) aus der finalen Analyse ausschließen. Die Anwendung der präregistrierten Ausschlusskriterien kann und wird deshalb wiederholt werden.
-   **Involved descriptions**: Die Beschreibungen aus den folgenden Quellen werden miteinbezogen und auf etwaige Inkohärenzen überprüft:
    -   Beschreibungen der Hypothesen, der Methoden, des Vorgehens und der Ergebnisse von Studie 4 im Artikel (S. 1738-1739)
    -   Beschreibungen der Schlussfolgerungen aus den Ergebnissen von Studie 4 in der Diskussion (S. 1740)
    -   Beschreibungen der Hypothesen, der geplanten Berechnung sowie der Ausschlusskriterien in der [Präregistierung](https://aspredicted.org/rr4r7.pdf)
    -   Beschreibungen der Berechnung der für die Regressionsanalyse benötigten Variablen im [Codebook](https://osf.io/yadqw)
    -   Für die Formel zur Berechnung der Diskrepanz zwischen Feedback und Selbstwahrnehmung musste auf eine Beschreibung in den [Zusatzmaterialien zu Studie 4](https://osf.io/yadqw) zurückgegriffen werden
-   **Inherited source code**: Der Quellcode für die Berechnung wird re-implementiert. Es wird nur dann auf Teile des [Quellcodes der Autoren](https://osf.io/yadqw) zurückgegriffen, wenn eine offene Frage bei der Implementierung nicht eigenständig geklärt werden kann.

## (b) Checking the Preconditions

-   Die anonymisierten Primärdaten konnten erfolgreich abgerufen und eingebunden werden:

```{r}
original_data <- read.csv2("../data/CleanData_S4_final.csv")
```

-   Die Autoren führen ihre Berechnung in R (R Core Team, 2018) durch. Für die Reproduktion wird die folgende R-Umgebung verwendet:

```{r}
#| echo: false

comp_env <- sessionInfo()
cat(paste0(comp_env$R.version$version.string, "\n", comp_env$platform, "\n", comp_env$running))
```

-   Die benötigten R-Pakete konnten installiert und eingebunden werden:

```{r}
#| warning: false
#| results: false

library(dplyr)
library(apaTables)
library(effectsize)
```

```{r, package-versions}
#| echo: false

comp_env <- sessionInfo()
dplyr_version <- paste(comp_env$otherPkgs$dplyr$Package, "version", comp_env$otherPkgs$dplyr$Version)
apaTables_version <- paste(comp_env$otherPkgs$apaTables$Package, "version", comp_env$otherPkgs$apaTables$Version)

cat(paste0(dplyr_version, "\n", apaTables_version))
```

::: callout-tip
## Fazit: Die Reproduktion kann durchgeführt werden

Alle Voraussetzungen für die Durchführung der Reproduktion sind erfüllt.
:::

## (c) Obtaining results

### Applying exclusion criteria

```{r}
# We will exclude participants

# - if they fail our attention check item 
# (i.e. if they don't select "strongly agree" 
# as the responses despite being instructed to).
data_after_exclusion <- original_data %>% filter(attention_coping == 9)
```

```{r}
# - if their responses to either of the discrepancy 
# attention checks is incorrect. If this leads to 
# more than 20% of participants being excluded, this 
# exclusion criterion will be relaxed.
n_before <- nrow(data_after_exclusion)

data_after_exclusion <- data_after_exclusion %>%
  filter(attention_sc == "right" & attention_task == "right")

n_after <- nrow(data_after_exclusion)

if ((n_before - n_after) / n_before <= 0.2) {
  cat("No need to relax the exclusion criterion \
      \nregarding the discrepancy attention checks.")
}

# - if they indicate that we should not use their data
# in their response to our "use-me" item.
data_after_exclusion <- data_after_exclusion %>% filter(use_me == "yes")
```

::: callout-tip
## Fazit: Ausschluss von Versuchspersonen erfolgreich reproduziert

Im Einklang mit der von Brotzeller und Gollwitzer (2025) berichteten Anzahl, wurden n = `r nrow(original_data) - nrow(data_after_exclusion)` Personen von der Analyse ausgeschlossen.
:::

### Data Pre-Processing

Der Datensatz wird auf die Spalten reduziert, die für die Berechnung der Variablen des Regressionsmodells benötigt sind:

```{r}
data <- data_after_exclusion %>% select(
  subject_nr,
  condition_ofi,
  starts_with("sc_t1_0"),
  starts_with("sc_t2_0"),
  task_emotion_score_percent
)
```

Die Selbstwahrnehmungen zu den Zeitpunkten t1 und t2 errechnen sich aus dem Mittelwert der Anworten auf die vier Items, mit denen die Selbstwahrnehmung abgefragt wurde:

```{r}
data <- data %>% mutate(
  sc_t1 = rowMeans(across(c(sc_t1_01, sc_t1_02, sc_t1_03, sc_t1_04))),
  sc_t2 = rowMeans(across(c(sc_t2_01, sc_t2_02, sc_t2_03, sc_t2_04))),
  .before = task_emotion_score_percent # höhere Übersichtlichkeit
)
```

Die absoluten Selbstkonzeptänderungen lassen sich aus dem Betrag der Differenz zwischen den Selbstwahrnehmungen zu beiden Zeitpunkten berechnen:

```{r}
data <- data %>% mutate(sc_diff_absolute = abs(sc_t2 - sc_t1))
```

Die Größe der Diskrepanz (`SoD`) lässt sich aus dem Betrag der Differenz zwischen dem Feedback und der Selbstwahrnehmung zum Zeitpunkt t1 berechnen. Die Richtung der Diskrepanz (`DoD`) aus dem Vorzeichen dieser Differenz.

::: callout-important
## Mistake 1: Inkohärenz bezüglich der Berechnung der Richtung der Diskrepanz

Im Codebook wird die Berechnung von `DoD` anders als im Artikel beschrieben. Die Beschreibung im Codebook ist falsch, weil hier die Diskrepanz zwischen Feedback und Selbstwahrnehmung aus der Differenz zwischen den Selbstwahrnehmungen zu beiden Zeitpunkten berechnet wird:

> "negative": (sc_t2-sc_t1) \< 0\
> "neither positive nor negative": (sc_t2-sc_t1) = 0\
> "positive": (sc_t2-sc_t1) \> 0\
:::

Weil das Feedback als Prozentwert vorliegt, muss die Differenz ebenfalls zu einem Prozentwert umgerechnet werden. Dazu müssen die Selbstwahrnehmungswerte von der ursprünglichen Skala von 1-9 auf die Skala 0-8 umgerechnet werden, die einen Nullpunkt hat. Das Feedback errechnet sich als prozentualer Gesamtwert aus den einzelnen Items des Reading-the-Mind-in-the-Eyes-Tests (Bölte, 2005); diese Berechnung wird nicht noch einmal wiederholt, sondern von den Autoren übernommen.

```{r}
# absolute discrepancy
data <- data %>% mutate(
  discrepancy = task_emotion_score_percent - ((sc_t1 - 1)/8)*100
)

# size of discrepancy
data <- data %>% mutate(sod = abs(discrepancy))

# direction of discrepancy
data <- data %>% mutate(dod = case_when(
  discrepancy > 0 ~ "positive",
  discrepancy < 0 ~ "negative",
  discrepancy == 0 ~ "neither positive nor negative"
))

# discrepancy ist keine Variable im originalen Datensatz
# und wird deshalb hier wieder entfernt.
data <- data %>% select(!discrepancy)
```

::: callout-important
## Obstacle 1: Berechnung der Größe der Diskrepanz ist unterspezifiziert

Folgt man den Beschreibungen von Brotzeller und Gollwitzer (2025) bei der Berechnung von `SoD` und `DoD`, stimmen die Werte nicht mit jenen überein, die die Autoren in ihrem Datensatz berechnet haben.

Eine Inspektion des ursprünglichen Datensatzes hat ergeben, dass die Werte von `SoD` gerundet werden müssen, auch wenn das in keiner der Quellen Erwähnung findet. Auch die genaue Rundungsmethode wird nicht spezifiziert.

Erst nach einigen Fehlversuchen konnte die richtige Rundungsmethode identifiziert werden. Sie entspricht der klassischen Rundungsmethode, d.h. Werte unter .5 werden abgerundet, Werte darüber hingegen aufgerundet. Weil R keine Standardfunktion für diese Rundungsmethode implementiert, musste sie eigens definiert werden.
:::

```{r}
round_half_up <- function(x) {
  # floor(x) rundet immer auf den nächsten Integer-Wert ab.
  floor(x + 0.5)
}

data <- data %>% mutate(
  sod = abs(task_emotion_score_percent - round_half_up(((sc_t1 - 1)/8)*100))
)
```

::: callout-tip
## Fazit: Erstellen der Variablen des Regressionsmodells erfolgreich reproduziert

Nachdem Mistake 1 gelöst und Obstacle 1 überwunden wurden, stimmen die Werte der neu berechneten Variablen mit den ursprünglichen Daten überein:

```{r}
#| warning: false
#| results: false

matches <- data %>%
  inner_join(data_after_exclusion)
```

```{r}
#| echo: false

cat(paste("In", nrow(matches), "von", nrow(data_after_exclusion), "Fällen stimmen die Daten überein."))
```
:::

### Regression analysis

Aus der Analyse werden die Daten aller Versuchspersonen ausgeschlossen, deren Selbstwahrnehmung mit dem Feedback übereinstimmte:

```{r}
#| echo: false
#| results: false

n_before <- nrow(data)
```

```{r}
data <- data %>% filter(dod != "neither positive nor negative")
```

```{r}
#| echo: false

cat(paste("Von den ", n_before, "infragekommenden Versuchspersonen wurden zusätzliche n =", n_before - nrow(data), "\nPersonen von der Analyse ausgeschlossen."))
```

Die Prädiktoren `DoD` und `opportunity for improvement (OFI)` werden effekt-kodiert:

```{r}
data <- data %>% mutate(
  dod_num = case_match(
    dod,
    "negative" ~ -1,
    "positive" ~ 1
  )
)

data <- data %>% mutate(
  ec_condition_ofi = case_match(
    condition_ofi,
    "low opportunity for improvement" ~ -1,
    "high opportunity for improvement" ~ 1
  )
)
```

Um die Interpretierbarkeit des Modells zu erhöhen, wird `SoD` z-standardisiert:

```{r}
data <- data %>% mutate(sod_standard = scale(sod))
```

Nun kann die Regressionanalyse durchgeführt werden. Dafür wird der `lm` Befehl verwendet, der in R standardmäßig implementiert ist:

```{r}
model_fit <- lm(sc_diff_absolute ~ ec_condition_ofi*dod_num*sod_standard, data)
```

Die Ergebnisse der Regressionsanalyse können mit dem folgenden Befehl inspiziert werden:

```{r}
summary(model_fit)
```

------------------------------------------------------------------------

Es fällt auf, dass der `lm`-Befehl für die einzelnen Koeffizienten nicht die Effektstärken $sr^2$ (squared semi-partial correlations) berechnet. Da Brotzeller und Gollwitzer (2025) diese Effektstärken angeben, müssen sie nachträglich berechnet werden.

::: callout-note
## Conflicting Choice 1: Mangelndes Wissen, um die Semipartialkorrelationen zu berechnen

Da ich weder weiß, wie man $sr^2$ in R berechnet, noch, wie man diese Effektgröße händisch berechnet, muss ich an dieser Stelle die Berechnungsmethode aus dem Quellcode der Autoren übernehmen.
:::

Der Befehl `apa.reg.table` aus dem Paket `apaTables` berechnet $sr^2$ automatisch mit:

```{r}
apa.reg.table(model_fit)
```

------------------------------------------------------------------------

## (d) Evaluating the Consistency of Results

::: callout-tip
## Fazit: Die berichteten Ergebnisse konnten reproduziert werden

Ein maueller Vergleich der neuberechneten mit den berichteten Ergebnissen zeigt, dass die Reproduktion **konsistente** Ergebnisse hervorgebracht hat. Rundet man die neuberechneten Werte auf zwei Nachkommastellen, sind sie sogar **numerisch identisch** zu den in Tabelle 2 (S. 1739) enthaltenen Werten.
:::
